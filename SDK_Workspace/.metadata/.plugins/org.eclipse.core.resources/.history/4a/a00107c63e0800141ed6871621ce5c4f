/*
 * warp_protocol.c
 *
 *  Created on: 2014-07-10
 *      Author: Hoai Phuoc Truong
 */

#include <warp_protocol.h>
#include <xil_types.h>

#define TYPE_INDEX                        0
#define SUBTYPE_INDEX                     1

#define TYPE_TRANSMIT                     1
#define TYPE_CONTROL                      2

#define SUBTYPE_NO_ACK_TRANSMIT           0
#define SUBTYPE_ACK_TRANSMIT              1

#define SUBTYPE_TRANSMISSION_CONTROL      1
#define SUBTYPE_MAC_ADDRESS_CONTROL       2

void transmit(u8* packet, u8 ack) {
	unsigned int retry = *(frame_data + 4);
	unsigned int i;
	for (i = 0; i < tx_length - 5; i++) {//Shift things by 5 bytes
		*(frame_data + i) = *(frame_data + i + 5);
	}
	tx_length = tx_length - 5;
}

int warp_protocol_process(u8* packet) {
	u8 type = packet[TYPE_INDEX];
	u8 subtype = packet[SUBTYPE_INDEX];

	switch (type) {
	case TYPE_TRANSMIT:
		switch (subtype) {
		case SUBTYPE_NO_ACK_TRANSMIT:
			transmit(packet + 2, 0);
			break;
		case SUBTYPE_ACK_TRANSMIT:
			transmit(packet + 2, 1);
			break;
		default:
			break;
		}
		break;
	case TYPE_CONTROL:
		switch (subtype) {
		case SUBTYPE_TRANSMISSION_CONTROL:

			break;
		case SUBTYPE_MAC_ADDRESS_CONTROL:
			break;
		default:
			break;
		}
		break;
	default: //Do nothing
		break;
	}

	return 0; //Success
}
